name: CD

on:
  push:
    branches:
      - main
    paths:
      - 'helm/charts/**/values_dev.yaml'
      - 'helm/charts/**/values_qa.yaml'

permissions:
  contents: write
  pull-requests: write

env:
  ARGOCD_SERVER: http://argocd.local/
  ARGOCD_NAMESPACE: argocd
  KARATE_IMAGE: harishdell/karate:1.0

jobs:
  detect-changes:
    name: Detect Environment Changes
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.detect.outputs.environment }}
      apps: ${{ steps.detect.outputs.apps }}
      image_version: ${{ steps.detect.outputs.image_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changes and extract image version
        id: detect
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          ENVIRONMENT=""
          APPS=""
          IMAGE_VERSION=""
          
          # Check which values file changed
          if echo "$CHANGED_FILES" | grep -q "values_dev.yaml"; then
            ENVIRONMENT="dev"
            # Extract image version from values_dev.yaml
            IMAGE_VERSION=$(grep "tag:" helm/charts/els-lmsserver/values_dev.yaml | head -1 | awk -F'"' '{print $2}')
          elif echo "$CHANGED_FILES" | grep -q "values_qa.yaml"; then
            ENVIRONMENT="qa"
            IMAGE_VERSION=$(grep "tag:" helm/charts/els-lmsserver/values_qa.yaml | head -1 | awk -F'"' '{print $2}')
          fi
          
          # Detect which apps changed
          if echo "$CHANGED_FILES" | grep -q "els-lmsclient/values"; then
            APPS="${APPS}lmsclient,"
          fi
          if echo "$CHANGED_FILES" | grep -q "els-lmsserver/values"; then
            APPS="${APPS}lmsserver,"
          fi
          
          APPS=${APPS%,}
          
          echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT
          echo "apps=${APPS}" >> $GITHUB_OUTPUT
          echo "image_version=${IMAGE_VERSION}" >> $GITHUB_OUTPUT
          
          echo "üéØ Environment: ${ENVIRONMENT}"
          echo "üì¶ Apps: ${APPS}"
          echo "üê≥ Image Version: ${IMAGE_VERSION}"

  trigger-argocd-sync:
    name: Trigger ArgoCD Sync
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.environment != ''
    steps:
      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x /usr/local/bin/argocd

      - name: Login to ArgoCD
        run: |
          argocd login ${{ env.ARGOCD_SERVER }} \
            --username ${{ secrets.ARGOCD_USERNAME }} \
            --password ${{ secrets.ARGOCD_PASSWORD }} \
            --grpc-web \
            --insecure  # Add this if using self-signed certificates

      - name: Sync Applications
        run: |
          IFS=',' read -ra APP_ARRAY <<< "${{ needs.detect-changes.outputs.apps }}"
          for app in "${APP_ARRAY[@]}"; do
            APP_NAME="els-${app}-${{ needs.detect-changes.outputs.environment }}"
            echo "üîÑ Syncing ArgoCD application: ${APP_NAME}"
            
            argocd app sync ${APP_NAME} \
              --grpc-web  # Force gRPC-web protocol
          done

      - name: Wait for Sync Completion
        run: |
          IFS=',' read -ra APP_ARRAY <<< "${{ needs.detect-changes.outputs.apps }}"
          for app in "${APP_ARRAY[@]}"; do
            APP_NAME="els-${app}-${{ needs.detect-changes.outputs.environment }}"
            echo "‚è≥ Waiting for ${APP_NAME} to become healthy..."
            
            argocd app wait ${APP_NAME} \
              --grpc-web \
              --health \
              --timeout 600
            
            echo "‚úÖ ${APP_NAME} is healthy and synced"
          done
  run-karate-tests:
    name: Run Karate Tests in Kubernetes
    runs-on: ubuntu-latest
    needs: [detect-changes, trigger-argocd-sync]
    if: needs.detect-changes.outputs.environment == 'dev'
    steps:
      - uses: actions/checkout@v4

      - name: Build and Push Karate Test Image
        run: |
          cd testing/functional/karate
          docker build -t $KARATE_IMAGE:${{ github.sha }} .
          docker push $KARATE_IMAGE:${{ github.sha }}

      - name: Deploy Karate Test Job
        run: |
          # Create temporary values file for karate tests
          cat > karate-values.yaml << EOF
          image:
            repository: $KARATE_IMAGE
            tag: ${{ github.sha }}
          karate:
            env: dev
            options: "--tags ~@ignore"
          test:
            url: "http://els-lmsserver-dev.els-lms-dev.svc.cluster.local:1337"
          EOF
          
          # Deploy karate test job using helm
          helm upgrade --install karate-test-${GITHUB_SHA:0:8} \
            helm/charts/karate-tests \
            -f karate-values.yaml \
            --namespace els-lms-dev \
            --create-namespace

      - name: Wait for Karate Test Completion
        run: |
          JOB_NAME="karate-test-${GITHUB_SHA:0:8}"
          echo "‚è≥ Waiting for karate test job: $JOB_NAME"
          
          # Wait for job completion
          kubectl wait --for=condition=complete job/$JOB_NAME \
            --namespace els-lms-dev \
            --timeout=600s
          
          echo "‚úÖ Karate tests completed successfully"

      - name: Get Test Results
        if: always()
        run: |
          JOB_NAME="karate-test-${GITHUB_SHA:0:8}"
          
          # Get test logs
          kubectl logs job/$JOB_NAME --namespace els-lms-dev
          
          # Extract test results (you might need to get from PVC)
          echo "üìä Test execution completed"

  promote-to-qa:
    name: Promote to QA on Test Success
    runs-on: ubuntu-latest
    needs: [detect-changes, run-karate-tests]
    if: |
      needs.detect-changes.outputs.environment == 'dev' &&
      needs.run-karate-tests.result == 'success'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Copy dev image tag to QA values
        run: |
          IMAGE_VERSION="${{ needs.detect-changes.outputs.image_version }}"
          
          for app in $(echo "${{ needs.detect-changes.outputs.apps }}" | tr ',' ' '); do
            QA_FILE="helm/charts/els-${app}/values_qa.yaml"
            
            if [ -f "$QA_FILE" ]; then
              sed -i "s|tag:.*|tag: \"${IMAGE_VERSION}\"|" "$QA_FILE"
              echo "‚úÖ Updated ${app} QA to tag: ${IMAGE_VERSION}"
            fi
          done

      - name: Commit and push QA updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add helm/charts/*/values_qa.yaml
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit"
          else
            git commit -m "ci: promote ${{ needs.detect-changes.outputs.image_version }} to QA [skip ci]"
            git push origin main
            echo "‚úÖ Promoted build to QA environment"
          fi

  cd-summary:
    name: CD Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, trigger-argocd-sync, run-karate-tests, promote-to-qa]
    if: always()
    steps:
      - run: |
          echo "## üöÄ CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.detect-changes.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Apps:** ${{ needs.detect-changes.outputs.apps }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Version:** ${{ needs.detect-changes.outputs.image_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ArgoCD Sync:** ${{ needs.trigger-argocd-sync.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Karate Tests:** ${{ needs.run-karate-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**QA Promotion:** ${{ needs.promote-to-qa.result }}" >> $GITHUB_STEP_SUMMARY
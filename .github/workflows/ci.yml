name: CI

on:
  push:
    branches:
      - 'feature/**'
      - 'bug/**'
      - 'major/**'
      - 'minor/**'
      - 'patch/**'
  

permissions:
  contents: write
  pull-requests: write

env:
  HELM_BASE: helm/charts
  DOCKER_ORG: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      lmsclient: ${{ steps.filter.outputs.lmsclient }}
      lmsserver: ${{ steps.filter.outputs.lmsserver }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            lmsclient:
              - 'developer/lmsclient/**'
            lmsserver:
              - 'developer/lmsserver/**'

  get-version:
    name: Get Next Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      semver: ${{ steps.version.outputs.semver }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for full git history[citation:8]
      
      - name: Calculate next version from branch name
        id: version
        run: |
          CURRENT=$(cat VERSION 2>/dev/null || echo "0.0.0")
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          
          # Determine bump type from branch name
          case "${BRANCH_NAME}" in
            major/*)
              BUMP="major"
              ;;
            minor/*)
              BUMP="minor"
              ;;
            patch/*)
              BUMP="patch"
              ;;
            *)
              BUMP="patch"  # Default for feature/bug branches
              ;;
          esac
          
          IFS='.' read -r major minor patch <<< "$CURRENT"
          
          case $BUMP in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
          esac
          
          NEXT_VERSION="${major}.${minor}.${patch}"
          SEMVER="v${NEXT_VERSION}"
          
          # Use branch name and commit SHA for dev builds
          CLEAN_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9]/-/g')
          DEV_VERSION="${NEXT_VERSION}-${CLEAN_BRANCH}-${GITHUB_SHA:0:8}"
          
          echo "version=${DEV_VERSION}" >> $GITHUB_OUTPUT
          echo "semver=${SEMVER}" >> $GITHUB_OUTPUT
          
          echo "üì¶ Current: $CURRENT"
          echo "üì¶ Branch: $BRANCH_NAME"
          echo "üì¶ Bump Type: $BUMP"
          echo "üì¶ Next Release: $SEMVER"
          echo "üì¶ Dev Build: $DEV_VERSION"
  test-lmsclient:
    name: Test LMS Client
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.lmsclient == 'true'
    steps:
      - uses: actions/checkout@v4
      - run: echo "üß™ Running els-lmsclient tests..."

  test-lmsserver:
    name: Test LMS Server
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.lmsserver == 'true'
    steps:
      - uses: actions/checkout@v4
      - run: echo "üß™ Running els-lmsserver tests..."

  build-lmsclient:
    name: Build & Push LMS Client
    runs-on: ubuntu-latest
    needs: [detect-changes, test-lmsclient, get-version]
    if: needs.detect-changes.outputs.lmsclient == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push
        run: |
          VERSION="${{ needs.get-version.outputs.version }}"
          
          docker build \
            -t $DOCKER_ORG/els-lmsclient:$VERSION \
            --build-arg REACT_APP_API_URL=http://els-lmsserver:1337 \
            ./developer/lmsclient

          docker push $DOCKER_ORG/els-lmsclient:$VERSION
          
          echo "‚úÖ Pushed: els-lmsclient:$VERSION"

  build-lmsserver:
    name: Build & Push LMS Server
    runs-on: ubuntu-latest
    needs: [detect-changes, test-lmsserver, get-version]
    if: needs.detect-changes.outputs.lmsserver == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push
        run: |
          VERSION="${{ needs.get-version.outputs.version }}"
          
          docker build \
            -t $DOCKER_ORG/els-lmsserver:$VERSION \
            ./developer/lmsserver

          docker push $DOCKER_ORG/els-lmsserver:$VERSION
          
          echo "‚úÖ Pushed: els-lmsserver:$VERSION"

  update-helm-dev:
    name: Update Helm Values for Dev
    runs-on: ubuntu-latest
    needs: [build-lmsclient, build-lmsserver, get-version]
    if: always() && (needs.build-lmsclient.result == 'success' || needs.build-lmsserver.result == 'success')
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.ref }}

      - name: Update values_dev.yaml files
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          VERSION="${{ needs.get-version.outputs.version }}"
          
          # Update lmsclient values_dev.yaml
          if [ "${{ needs.build-lmsclient.result }}" == "success" ]; then
            sed -i "s/tag: .*/tag: \"${VERSION}\"/" \
              $HELM_BASE/els-lmsclient/values_dev.yaml
            echo "‚úÖ Updated els-lmsclient/values_dev.yaml"
          fi
          
          # Update lmsserver values_dev.yaml
          if [ "${{ needs.build-lmsserver.result }}" == "success" ]; then
            sed -i "s/tag: .*/tag: \"${VERSION}\"/" \
              $HELM_BASE/els-lmsserver/values_dev.yaml
            echo "‚úÖ Updated els-lmsserver/values_dev.yaml"
          fi
      - name: Register branch in ArgoCD ApplicationSet
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          APPLICATIONSET_FILE="helm/charts/argocd/applicationset/els-lmsserver-simple.yaml"
          
          # Check if branch matches our patterns
          if [[ "$BRANCH_NAME" =~ ^(feature|bug|bugfix|patch|minor|major)/.+ ]]; then
            echo "üìù Registering branch in ArgoCD ApplicationSet: $BRANCH_NAME"
            
            # Check if branch already exists in the list
            if grep -q "branch: $BRANCH_NAME" "$APPLICATIONSET_FILE"; then
              echo "‚ÑπÔ∏è Branch already registered in ApplicationSet"
            else
              # Add branch to the list (before the template section)
              sed -i "/elements:/a\\      - branch: $BRANCH_NAME\\n        namespace: els-lms-dev" "$APPLICATIONSET_FILE"
              echo "‚úÖ Added branch to ApplicationSet"
              git add "$APPLICATIONSET_FILE"
            fi
          else
            echo "‚ÑπÔ∏è Branch $BRANCH_NAME doesn't match deployment patterns, skipping ArgoCD registration"
          fi

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add $HELM_BASE/*/values_dev.yaml
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit"
          else
            git commit -m "chore: update dev image tags to ${{ needs.get-version.outputs.version }} [skip ci]"
            git push
            echo "‚úÖ Pushed Helm value updates"
          fi
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [get-version, build-lmsclient, build-lmsserver, update-helm-dev]
    if: always()
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.get-version.outputs.version }}';
            const semver = '${{ needs.get-version.outputs.semver }}';
            const branch = '${{ github.ref_name }}';
            
            let summary = `## üöÄ CI Pipeline Summary\n\n`;
            summary += `**Branch:** \`${branch}\`\n`;
            summary += `**Dev Build Version:** \`${version}\`\n`;
            summary += `**Future Release Version:** \`${semver}\`\n\n`;
            summary += `### üì¶ Built Images:\n`;
            
            if ('${{ needs.build-lmsclient.result }}' === 'success') {
              summary += `- ‚úÖ \`els-lmsclient:${version}\`\n`;
            }
            if ('${{ needs.build-lmsserver.result }}' === 'success') {
              summary += `- ‚úÖ \`els-lmsserver:${version}\`\n`;
            }
            
            summary += `\n### üìù Next Steps:\n`;
            summary += `1. ArgoCD will detect changes in \`values_dev.yaml\`\n`;
            summary += `2. Automatic deployment to **dev** environment\n`;
            summary += `3. Karate tests will run post-deployment\n`;
            summary += `4. After merge, version \`${semver}\` will be released\n`;
            
            // Log summary to console
            console.log(summary);
            
            // Try to post comment if this is a PR, otherwise just log
            try {
              if (context.issue.number) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: summary
                });
                console.log('‚úÖ Posted comment to PR #' + context.issue.number);
              } else {
                // Not a PR, try to find related PR
                const prs = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  head: `${context.repo.owner}:${branch}`,
                  state: 'open'
                });
                
                if (prs.data.length > 0) {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: prs.data[0].number,
                    body: summary
                  });
                  console.log('‚úÖ Posted comment to PR #' + prs.data[0].number);
                } else {
                  console.log('‚ÑπÔ∏è No PR found for this branch - summary logged to console');
                }
              }
            } catch (error) {
              console.log('‚ö†Ô∏è Could not post PR comment:', error.message);
              console.log('üìä Summary logged to console instead');
            }
  
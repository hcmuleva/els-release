name: CI

on:
  push:
    branches:
      - 'feature/**'
      - 'bug/**'
      - 'major/**'
      - 'minor/**'
      - 'patch/**'

permissions:
  contents: write
  pull-requests: write

env:
  HELM_BASE: helm/charts
  DOCKER_ORG: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      lmsclient: ${{ steps.filter.outputs.lmsclient }}
      lmsserver: ${{ steps.filter.outputs.lmsserver }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            lmsclient:
              - 'developer/lmsclient/**'
            lmsserver:
              - 'developer/lmsserver/**'

  get-version:
    name: Get Next Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      sequence: ${{ steps.version.outputs.sequence }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main  # Checkout main to get the sequence file
      
      - name: Get or create sequence counter
        id: sequence
        run: |
          # Create sequence file if it doesn't exist
          if [ ! -f .ci-sequence ]; then
            echo "1" > .ci-sequence
          fi
          
          # Read current sequence from main branch
          CURRENT_SEQUENCE=$(cat .ci-sequence)
          echo "Current sequence: $CURRENT_SEQUENCE"
          
          # Output current sequence for use
          echo "sequence=$CURRENT_SEQUENCE" >> $GITHUB_OUTPUT

      - name: Calculate simple version
        id: version
        run: |
          SEQUENCE="${{ steps.sequence.outputs.sequence }}"
          
          # Simple version: sh_001, sh_002, etc.
          VERSION="sh_$(printf "%03d" $SEQUENCE)"
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: ${VERSION}"
          echo "ðŸ”¢ Sequence: ${SEQUENCE}"

  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest
    needs: [detect-changes, get-version]
    steps:
      - name: Dummy Unit Tests
        if: needs.detect-changes.outputs.lmsclient == 'true' || needs.detect-changes.outputs.lmsserver == 'true'
        run: |
          echo "âœ… Dummy unit tests passed"
          
      - name: Dummy Security Scan
        if: needs.detect-changes.outputs.lmsclient == 'true' || needs.detect-changes.outputs.lmsserver == 'true'
        run: |
          echo "âœ… Dummy security scan passed"
          
      - name: Dummy Code Quality
        if: needs.detect-changes.outputs.lmsclient == 'true' || needs.detect-changes.outputs.lmsserver == 'true'
        run: |
          echo "âœ… Dummy code quality checks passed"

  build-lmsclient:
    name: Build & Push LMS Client
    runs-on: ubuntu-latest
    needs: [detect-changes, get-version, quality-checks]
    if: needs.detect-changes.outputs.lmsclient == 'true' && needs.quality-checks.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push
        run: |
          VERSION="${{ needs.get-version.outputs.version }}"
          
          docker build \
            -t $DOCKER_ORG/els-lmsclient:$VERSION \
            --build-arg REACT_APP_API_URL=http://els-lmsserver:1337 \
            ./developer/lmsclient

          docker push $DOCKER_ORG/els-lmsclient:$VERSION
          
          echo "âœ… Pushed: els-lmsclient:$VERSION"

  build-lmsserver:
    name: Build & Push LMS Server
    runs-on: ubuntu-latest
    needs: [detect-changes, get-version, quality-checks]
    if: needs.detect-changes.outputs.lmsserver == 'true' && needs.quality-checks.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push
        run: |
          VERSION="${{ needs.get-version.outputs.version }}"
          
          docker build \
            -t $DOCKER_ORG/els-lmsserver:$VERSION \
            ./developer/lmsserver

          docker push $DOCKER_ORG/els-lmsserver:$VERSION
          
          echo "âœ… Pushed: els-lmsserver:$VERSION"

  merge-to-main:
    name: Merge to Main on Success
    runs-on: ubuntu-latest
    needs: [build-lmsclient, build-lmsserver, get-version]
    if: |
      (needs.build-lmsclient.result == 'success' || needs.build-lmsserver.result == 'success') &&
      always() &&
      contains(needs.*.result, 'success')
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Update values_dev.yaml on main branch
        run: |
          VERSION="${{ needs.get-version.outputs.version }}"
          
          # Update lmsclient values_dev.yaml on main
          if [ "${{ needs.build-lmsclient.result }}" == "success" ]; then
            sed -i "s|tag:.*|tag: \"${VERSION}\"|" $HELM_BASE/els-lmsclient/values_dev.yaml
            echo "âœ… Updated els-lmsclient/values_dev.yaml on main to tag: ${VERSION}"
          fi
          
          # Update lmsserver values_dev.yaml on main
          if [ "${{ needs.build-lmsserver.result }}" == "success" ]; then
            sed -i "s|tag:.*|tag: \"${VERSION}\"|" $HELM_BASE/els-lmsserver/values_dev.yaml
            echo "âœ… Updated els-lmsserver/values_dev.yaml on main to tag: ${VERSION}"
          fi

      - name: Increment sequence counter on main
        run: |
          CURRENT_SEQUENCE="${{ needs.get-version.outputs.sequence }}"
          NEXT_SEQUENCE=$((CURRENT_SEQUENCE + 1))
          
          echo "ðŸ”„ Updating sequence from $CURRENT_SEQUENCE to $NEXT_SEQUENCE"
          echo "$NEXT_SEQUENCE" > .ci-sequence

      - name: Commit changes to main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add $HELM_BASE/*/values_dev.yaml .ci-sequence
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            git commit -m "ci: deploy ${{ needs.get-version.outputs.version }} to dev [skip ci]"
            git push origin main
            echo "âœ… Pushed changes to main branch"
          fi

  ci-summary:
  name: CI Summary
  runs-on: ubuntu-latest
  needs: [get-version, build-lmsclient, build-lmsserver, merge-to-main]
  if: always()
  steps:
    - name: Create Workflow Summary
      run: |
        echo "## ðŸš€ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build Version:** \`${{ needs.get-version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Sequence Number:** \`${{ needs.get-version.outputs.sequence }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Main Branch Updated:** ${{ needs.merge-to-main.result == 'success' && 'âœ… Yes' || 'âŒ No' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Built Images:" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.build-lmsclient.result }}" == "success" ]; then
          echo "- âœ… \`els-lmsclient:${{ needs.get-version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.build-lmsserver.result }}" == "success" ]; then
          echo "- âœ… \`els-lmsserver:${{ needs.get-version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.merge-to-main.result }}" == "success" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… CD Pipeline Triggered:" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… values_dev.yaml updated on main branch" >> $GITHUB_STEP_SUMMARY
          echo "2. ðŸ”„ ArgoCD will auto-detect changes" >> $GITHUB_STEP_SUMMARY
          echo "3. ðŸš€ Automatic deployment to **dev** environment" >> $GITHUB_STEP_SUMMARY
          echo "4. ðŸ§ª Karate tests will run post-deployment" >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âŒ CD Pipeline Not Triggered:" >> $GITHUB_STEP_SUMMARY
          echo "CI pipeline did not complete successfully" >> $GITHUB_STEP_SUMMARY
        fi
name: CI

on:
  push:
    branches:
      - 'feature/**'
      - 'bug/**'
      - 'major/**'
      - 'minor/**'
      - 'patch/**'
  

permissions:
  contents: write
  pull-requests: write

env:
  HELM_BASE: helm/charts
  DOCKER_ORG: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      lmsclient: ${{ steps.filter.outputs.lmsclient }}
      lmsserver: ${{ steps.filter.outputs.lmsserver }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            lmsclient:
              - 'developer/lmsclient/**'
            lmsserver:
              - 'developer/lmsserver/**'

  get-version:
    name: Get Next Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      semver: ${{ steps.version.outputs.semver }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get PR labels
        id: pr-labels
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            const labels = pr.data.labels.map(l => l.name);
            core.setOutput('labels', labels.join(','));
            
            // Determine bump type
            let bump = 'patch';
            if (labels.includes('major')) bump = 'major';
            else if (labels.includes('minor')) bump = 'minor';
            
            core.setOutput('bump', bump);
            return bump;

      - name: Calculate next version
        id: version
        run: |
          CURRENT=$(cat VERSION 2>/dev/null || echo "0.0.0")
          BUMP="${{ steps.pr-labels.outputs.bump }}"
          
          IFS='.' read -r major minor patch <<< "$CURRENT"
          
          case $BUMP in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
          esac
          
          NEXT_VERSION="${major}.${minor}.${patch}"
          SEMVER="v${NEXT_VERSION}"
          
          # Use PR number for dev builds
          DEV_VERSION="${NEXT_VERSION}-pr${{ github.event.pull_request.number }}"
          
          echo "version=${DEV_VERSION}" >> $GITHUB_OUTPUT
          echo "semver=${SEMVER}" >> $GITHUB_OUTPUT
          
          echo "üì¶ Current: $CURRENT"
          echo "üì¶ Next Release: $SEMVER"
          echo "üì¶ Dev Build: $DEV_VERSION"

  test-lmsclient:
    name: Test LMS Client
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.lmsclient == 'true'
    steps:
      - uses: actions/checkout@v4
      - run: echo "üß™ Running els-lmsclient tests..."

  test-lmsserver:
    name: Test LMS Server
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.lmsserver == 'true'
    steps:
      - uses: actions/checkout@v4
      - run: echo "üß™ Running els-lmsserver tests..."

  build-lmsclient:
    name: Build & Push LMS Client
    runs-on: ubuntu-latest
    needs: [detect-changes, test-lmsclient, get-version]
    if: needs.detect-changes.outputs.lmsclient == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push
        run: |
          VERSION="${{ needs.get-version.outputs.version }}"
          
          docker build \
            -t $DOCKER_ORG/els-lmsclient:$VERSION \
            --build-arg REACT_APP_API_URL=http://els-lmsserver:1337 \
            ./developer/lmsclient

          docker push $DOCKER_ORG/els-lmsclient:$VERSION
          
          echo "‚úÖ Pushed: els-lmsclient:$VERSION"

  build-lmsserver:
    name: Build & Push LMS Server
    runs-on: ubuntu-latest
    needs: [detect-changes, test-lmsserver, get-version]
    if: needs.detect-changes.outputs.lmsserver == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push
        run: |
          VERSION="${{ needs.get-version.outputs.version }}"
          
          docker build \
            -t $DOCKER_ORG/els-lmsserver:$VERSION \
            ./developer/lmsserver

          docker push $DOCKER_ORG/els-lmsserver:$VERSION
          
          echo "‚úÖ Pushed: els-lmsserver:$VERSION"

  update-helm-dev:
    name: Update Helm Values for Dev
    runs-on: ubuntu-latest
    needs: [build-lmsclient, build-lmsserver, get-version]
    if: always() && (needs.build-lmsclient.result == 'success' || needs.build-lmsserver.result == 'success')
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}

      - name: Update values_dev.yaml files
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          VERSION="${{ needs.get-version.outputs.version }}"
          
          # Update lmsclient values_dev.yaml
          if [ "${{ needs.build-lmsclient.result }}" == "success" ]; then
            sed -i "s/tag: .*/tag: \"${VERSION}\"/" \
              $HELM_BASE/els-lmsclient/values_dev.yaml
            echo "‚úÖ Updated els-lmsclient/values_dev.yaml"
          fi
          
          # Update lmsserver values_dev.yaml
          if [ "${{ needs.build-lmsserver.result }}" == "success" ]; then
            sed -i "s/tag: .*/tag: \"${VERSION}\"/" \
              $HELM_BASE/els-lmsserver/values_dev.yaml
            echo "‚úÖ Updated els-lmsserver/values_dev.yaml"
          fi

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add $HELM_BASE/*/values_dev.yaml
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit"
          else
            git commit -m "chore: update dev image tags to ${{ needs.get-version.outputs.version }} [skip ci]"
            git push
            echo "‚úÖ Pushed Helm value updates"
          fi

  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [get-version, build-lmsclient, build-lmsserver, update-helm-dev]
    if: always()
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.get-version.outputs.version }}';
            const semver = '${{ needs.get-version.outputs.semver }}';
            
            let body = `## üöÄ CI Pipeline Summary\n\n`;
            body += `**Dev Build Version:** \`${version}\`\n`;
            body += `**Future Release Version:** \`${semver}\`\n\n`;
            body += `### üì¶ Built Images:\n`;
            
            if ('${{ needs.build-lmsclient.result }}' === 'success') {
              body += `- ‚úÖ \`els-lmsclient:${version}\`\n`;
            }
            if ('${{ needs.build-lmsserver.result }}' === 'success') {
              body += `- ‚úÖ \`els-lmsserver:${version}\`\n`;
            }
            
            body += `\n### üìù Next Steps:\n`;
            body += `1. ArgoCD will detect changes in \`values_dev.yaml\`\n`;
            body += `2. Automatic deployment to **dev** environment\n`;
            body += `3. Karate tests will run post-deployment\n`;
            body += `4. After merge, version \`${semver}\` will be released\n`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: helm-updates-${{ github.ref }}
  cancel-in-progress: false

env:
  HELM_BASE: helm/charts
  DEFAULT_ENV: dev
  DOCKER_ORG: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      lmsclient: ${{ steps.filter.outputs.lmsclient }}
      lmsserver: ${{ steps.filter.outputs.lmsserver }}
      helm: ${{ steps.filter.outputs.helm }}
      ci: ${{ steps.filter.outputs.ci }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            lmsclient:
              - 'developer/lmsclient/**'
              - 'helm/charts/els-lmsclient/**'
            lmsserver:
              - 'developer/lmsserver/**'
              - 'helm/charts/els-lmsserver/**'
            helm:
              - 'helm/**'
            ci:
              - '.github/workflows/**'

      - run: |
          echo "ğŸ” Change Detection Results:"
          echo "LMS Client: ${{ steps.filter.outputs.lmsclient }}"
          echo "LMS Server: ${{ steps.filter.outputs.lmsserver }}"
          echo "Helm: ${{ steps.filter.outputs.helm }}"

  determine-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      env_file: ${{ steps.setenv.outputs.env_file }}
      api_url: ${{ steps.setenv.outputs.api_url }}
    steps:
      - name: Select environment values file and API URL
        id: setenv
        run: |
          LABELS=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/labels \
            | jq -r '.[].name')

          echo "Detected labels: $LABELS"

          if echo "$LABELS" | grep -q "major"; then
            ENV_FILE="values_prod.yaml"
            API_URL="https://lms-api.company.com"
          elif echo "$LABELS" | grep -q "minor"; then
            ENV_FILE="values_qa.yaml"
            API_URL="https://qa-lms-api.company.com"
          else
            ENV_FILE="values_dev.yaml"
            API_URL="http://els-lmsserver:1337"
          fi

          echo "Using Helm values file: $ENV_FILE"
          echo "API URL: $API_URL"

          echo "env_file=$ENV_FILE" >> $GITHUB_OUTPUT
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT

  test-lmsclient:
    name: Test LMS Client
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.lmsclient == 'true'
    steps:
      - uses: actions/checkout@v4
      - run: |
          echo "ğŸ§ª Running els-lmsclient tests..."
          # cd developer/lmsclient && npm install && npm test

  test-lmsserver:
    name: Test LMS Server
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.lmsserver == 'true'
    steps:
      - uses: actions/checkout@v4
      - run: |
          echo "ğŸ§ª Running els-lmsserver tests..."
          # cd developer/lmsserver && npm install && npm test

  build-lmsclient:
    name: Build & Push LMS Client
    runs-on: ubuntu-latest
    needs: [detect-changes, test-lmsclient, determine-environment]
    if: needs.detect-changes.outputs.lmsclient == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ—ï¸ Build & Push Docker Image (with REACT_APP_API_URL)
        run: |
          VERSION=$(cat VERSION 2>/dev/null || echo "latest")
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Building React app with API_URL=${{ needs.determine-environment.outputs.api_url }}"

          docker build \
            -t $DOCKER_ORG/els-lmsclient:$VERSION \
            -t $DOCKER_ORG/els-lmsclient:latest \
            ./developer/lmsclient

          docker push $DOCKER_ORG/els-lmsclient:$VERSION
          docker push $DOCKER_ORG/els-lmsclient:latest

  build-lmsserver:
    name: Build & Push LMS Server
    runs-on: ubuntu-latest
    needs: [detect-changes, test-lmsserver]
    if: needs.detect-changes.outputs.lmsserver == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - run: |
          VERSION=$(cat VERSION 2>/dev/null || echo "latest")
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          docker build -t $DOCKER_ORG/els-lmsserver:$VERSION -t $DOCKER_ORG/els-lmsserver:latest ./developer/lmsserver
          docker push $DOCKER_ORG/els-lmsserver:$VERSION
          docker push $DOCKER_ORG/els-lmsserver:latest

  
  deploy-helm:
    name: Deploy Helm Chart
    runs-on: ubuntu-latest
    needs: [build-lmsclient, build-lmsserver, determine-environment]
    if: |
      (needs.build-lmsclient.result == 'success' || needs.build-lmsserver.result == 'success') &&
      github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Helm
      uses: azure/setup-helm@v4

      - name: Deploy updated charts
      run: |
        VERSION=$(cat VERSION 2>/dev/null || echo "latest")
        ENV_FILE=${{ needs.determine-environment.outputs.env_file }}

        echo "ğŸ“¦ Using environment file: $ENV_FILE"
        echo "ğŸ“¦ Using image tag: $VERSION"

        # Deploy client
        if [ "${{ needs.build-lmsclient.result }}" == "success" ]; then
          echo "ğŸš€ Deploying els-lmsclient Helm chart"
          helm upgrade --install els-lmsclient \
            $HELM_BASE/els-lmsclient \
            -f $HELM_BASE/els-lmsclient/${ENV_FILE} \
            --set image.tag=$VERSION \
            --namespace els-lms --create-namespace
        fi

        # Deploy server
        if [ "${{ needs.build-lmsserver.result }}" == "success" ]; then
          echo "ğŸš€ Deploying els-lmsserver Helm chart"
          helm upgrade --install els-lmsserver \
            $HELM_BASE/els-lmsserver \
            -f $HELM_BASE/els-lmsserver/${ENV_FILE} \
            --set image.tag=$VERSION \
            --namespace els-lms --create-namespace
        fi

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [detect-changes, determine-environment, build-lmsclient, build-lmsserver, deploy-helm]
    if: always()
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const results = ${{ toJSON(needs) }};
            const failed = Object.values(results).some(j => j.result === 'failure');
            if (failed) core.setFailed("âŒ One or more jobs failed");
            else core.info("âœ… All CI checks passed!");

name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: read

jobs:
  # Detect changes using path filters
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      lmsclient: ${{ steps.filter.outputs.lmsclient }}
      lmsserver: ${{ steps.filter.outputs.lmsserver }}
      helm: ${{ steps.filter.outputs.helm }}
      ci: ${{ steps.filter.outputs.ci }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            lmsclient:
              - 'developer/lmsclient/**'
            lmsserver:
              - 'developer/lmsserver/**'
            helm:
              - 'helm/**'
            ci:
              - '.github/workflows/**'

      - name: Show detected changes
        run: |
          echo "üîç Change Detection Results:"
          echo "LMS Client changed: ${{ steps.filter.outputs.lmsclient }}"
          echo "LMS Server changed: ${{ steps.filter.outputs.lmsserver }}"
          echo "Helm charts changed: ${{ steps.filter.outputs.helm }}"
          echo "CI workflows changed: ${{ steps.filter.outputs.ci }}"

  # Validate PR has proper labels for versioning
  validate-labels:
    name: Validate PR Labels
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Wait for auto-labeler
        if: github.event.action == 'opened' || github.event.action == 'reopened'
        run: |
          echo "‚è≥ Waiting 5 seconds for auto-labeler to complete..."
          sleep 5

      - name: Check for version label
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const labels = pr.labels.map(l => l.name);
            const versionLabels = ['major', 'minor', 'patch'];
            const hasVersionLabel = labels.some(label => versionLabels.includes(label));
            
            core.info(`Current labels: ${labels.join(', ')}`);
            
            if (!hasVersionLabel) {
              core.setFailed('‚ùå PR must have one of: major, minor, or patch label');
            } else {
              const foundLabel = labels.find(l => versionLabels.includes(l));
              core.info(`‚úì Found version label: ${foundLabel}`);
            }

  # Test LMS Client (only if changed)
  test-lmsclient:
    name: Test LMS Client
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.lmsclient == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Run lmsclient tests
        run: |
          echo "‚úì Running lmsclient tests..."
          # cd developer/lmsclient
          # npm test

  # Test LMS Server (only if changed)
  test-lmsserver:
    name: Test LMS Server
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.lmsserver == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Run lmsserver tests
        run: |
          echo "‚úì Running lmsserver tests..."
          # cd developer/lmsserver
          # npm test

  # Build LMS Client Docker Image (only if changed)
  build-lmsclient:
    name: Build & Push LMS Client
    runs-on: ubuntu-latest
    needs: [detect-changes, test-lmsclient]
    if: |
      always() &&
      needs.detect-changes.outputs.lmsclient == 'true' &&
      (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract version
        id: version
        run: |
          if [ -f VERSION ]; then
            VERSION=$(cat VERSION)
          else
            VERSION="latest"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "Building lmsclient version: ${VERSION}"

      - name: Build & Push lmsclient
        uses: docker/build-push-action@v6
        with:
          context: ./developer/lmsclient
          file: ./developer/lmsclient/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/els-lmsclient:${{ env.VERSION }}
            ${{ secrets.DOCKERHUB_USERNAME }}/els-lmsclient:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/els-lmsclient:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/els-lmsclient:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/els-lmsclient:buildcache,mode=max

      - name: Summary
        run: |
          echo "## ‚úÖ LMS Client Built" >> $GITHUB_STEP_SUMMARY
          echo "- Version: ${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- Image: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/els-lmsclient:${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- SHA: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # Build LMS Server Docker Image (only if changed)
  build-lmsserver:
    name: Build & Push LMS Server
    runs-on: ubuntu-latest
    needs: [detect-changes, test-lmsserver]
    if: |
      always() &&
      needs.detect-changes.outputs.lmsserver == 'true' &&
      (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract version
        id: version
        run: |
          if [ -f VERSION ]; then
            VERSION=$(cat VERSION)
          else
            VERSION="latest"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "Building lmsserver version: ${VERSION}"

      - name: Build & Push lmsserver
        uses: docker/build-push-action@v6
        with:
          context: ./developer/lmsserver
          file: ./developer/lmsserver/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/els-lmsserver:${{ env.VERSION }}
            ${{ secrets.DOCKERHUB_USERNAME }}/els-lmsserver:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/els-lmsserver:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/els-lmsserver:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/els-lmsserver:buildcache,mode=max

      - name: Summary
        run: |
          echo "## ‚úÖ LMS Server Built" >> $GITHUB_STEP_SUMMARY
          echo "- Version: ${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- Image: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/els-lmsserver:${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- SHA: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # CI Success Check
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [detect-changes, validate-labels, build-lmsclient, build-lmsserver]
    if: always()
    steps:
      - name: Check all jobs
        uses: actions/github-script@v7
        with:
          script: |
            const needs = ${{ toJSON(needs) }};
            const detectChanges = needs['detect-changes'];
            const validateLabels = needs['validate-labels'];
            const buildClient = needs['build-lmsclient'];
            const buildServer = needs['build-lmsserver'];
            
            core.info('üìä Job Results:');
            core.info(`  - detect-changes: ${detectChanges.result}`);
            core.info(`  - validate-labels: ${validateLabels.result}`);
            core.info(`  - build-lmsclient: ${buildClient.result}`);
            core.info(`  - build-lmsserver: ${buildServer.result}`);
            
            // Check if any required job failed
            const failed = Object.values(needs).some(job => 
              job.result === 'failure'
            );
            
            if (failed) {
              core.setFailed('‚ùå One or more CI jobs failed');
            } else {
              core.info('‚úÖ All CI checks passed');
            }
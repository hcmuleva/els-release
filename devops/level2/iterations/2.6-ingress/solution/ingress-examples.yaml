# Path-based Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: temple-stack-ingress
  namespace: level2
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/use-regex: "true"
spec:
  ingressClassName: nginx
  rules:
  - http:
      paths:
      # API routes
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: temple-api-service
            port:
              number: 1337
      
      # Admin panel
      - path: /admin
        pathType: Prefix
        backend:
          service:
            name: temple-api-service
            port:
              number: 1337
      
      # Health check
      - path: /_health
        pathType: Prefix
        backend:
          service:
            name: temple-api-service
            port:
              number: 1337
      
      # UI (default/catch-all)
      - path: /
        pathType: Prefix
        backend:
          service:
            name: temple-ui-service
            port:
              number: 80

---
# Host-based Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: temple-hosts-ingress
  namespace: level2
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
spec:
  ingressClassName: nginx
  rules:
  # API subdomain
  - host: api.temple.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: temple-api-service
            port:
              number: 1337
  
  # UI main domain
  - host: temple.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: temple-ui-service
            port:
              number: 80

---
# TLS/HTTPS Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: temple-tls-ingress
  namespace: level2
  annotations:
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"  # If using cert-manager
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - temple.local
    - api.temple.local
    secretName: temple-tls  # TLS certificate secret
  rules:
  - host: temple.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: temple-ui-service
            port:
              number: 80
  - host: api.temple.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: temple-api-service
            port:
              number: 1337

---
# Install NGINX Ingress Controller:
# kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.1/deploy/static/provider/cloud/deploy.yaml

# Create TLS secret:
# openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
#   -keyout tls.key -out tls.crt \
#   -subj "/CN=temple.local/O=temple.local"
# kubectl create secret tls temple-tls --cert=tls.crt --key=tls.key -n level2

# Update /etc/hosts:
# sudo sh -c 'echo "127.0.0.1 temple.local api.temple.local" >> /etc/hosts'

# Test:
# curl http://localhost/
# curl http://localhost/api/_health
# curl http://temple.local
# curl http://api.temple.local
# curl -k https://temple.local
